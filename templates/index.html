<!DOCTYPE html>
<html>
<head>
  <title>控制 ROS 無人車</title>
</head>
<body>
  <h2>遠端控制</h2>

  <div id="time" style="font-size: 18px; margin-bottom: 10px;"></div>
  <div id="latency" style="font-size: 16px; color: green; margin-bottom: 10px;"></div>

  <button onclick="send('forward')">前進</button>
  <button onclick="send('back')">後退</button>
  <button onclick="send('stop')">停止</button>

  <script>
    function updateTime() {
      const now = new Date();
      const formatted = now.toLocaleString();
      document.getElementById('time').innerText = "現在時間：" + formatted;
    }

    setInterval(updateTime, 1000);
    updateTime();

    function send(cmd) {
      const t0 = performance.now();
      const client_time = new Date().toISOString();

      fetch('https://ros-web-control.onrender.com/control', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          command: cmd,
          client_time: client_time
        })
      })
      .then(res => res.json())
      .then(data => {
        const t1 = performance.now();
        const latency = Math.round(t1 - t0);

        let info = `📡 傳輸延遲（client）：${latency} ms`;
        if (data.delay_ms !== null) {
          info += `\n⏱ 指令延遲（server 計算）：${data.delay_ms} ms`;
        }
        if (data.server_time_taiwan) {
          info += `\n🕒 伺服器時間（台灣）：${data.server_time_taiwan}`;
        }

        document.getElementById('latency').innerText = info;
        alert("✅ 已送出指令：" + cmd);
      });
    }
  </script>
</body>
</html>
